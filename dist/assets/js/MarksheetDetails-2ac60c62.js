import{j as e,a,F as D,u as V}from"./index-6278ea70.js";import{f as L,u as T,r as i}from"./react-vendor-bd533c48.js";import{d as H,a as $}from"./resultUtils-190b400a.js";function Q(){var k,R,_,C,I,M,E,O,P,q,A,F;const{id:l}=L(),x=T(),[t,u]=i.useState(null),[v,f]=i.useState(!0),[b,h]=i.useState(""),[o,N]=i.useState(!1),[y,p]=i.useState({studentDetails:{},subjects:[]}),[n]=i.useState(()=>{try{const r=localStorage.getItem("auth");return r?JSON.parse(r):null}catch{return null}});i.useEffect(()=>{(async()=>{if(!l||l==="undefined"||l==="null"){h("Invalid marksheet id"),f(!1);return}try{const s=await fetch(`/api/marksheets?marksheetId=${encodeURIComponent(l)}`),d=await s.json();!s.ok||!d.success||!d.marksheet?h(d.error||"Failed to load marksheet"):(u(d.marksheet),d.marksheet&&p({studentDetails:{...d.marksheet.studentDetails||{}},subjects:Array.isArray(d.marksheet.subjects)?d.marksheet.subjects.map(g=>{const m=$(g);return{...g,result:m==="—"?"Pass":m}}):[]}))}catch(s){h(s.message||"Unexpected error")}finally{f(!1)}})()},[l]);const c=i.useMemo(()=>{const r=(t==null?void 0:t.status)||"unknown",s={draft:{label:"Draft",className:"bg-gray-100 text-gray-800"},verified_by_staff:{label:"Verified by Staff",className:"bg-green-100 text-green-800"},dispatch_requested:{label:"Dispatch Requested",className:"bg-yellow-100 text-yellow-800"},rescheduled_by_hod:{label:"Rescheduled by HOD",className:"bg-orange-100 text-orange-800"},approved_by_hod:{label:"Approved by HOD",className:"bg-blue-100 text-blue-800"},rejected_by_hod:{label:"Rejected by HOD",className:"bg-red-100 text-red-800"},dispatched:{label:"Dispatched",className:"bg-purple-100 text-purple-800"},unknown:{label:"Unknown",className:"bg-gray-200 text-gray-700"}};return s[r]||s.unknown},[t]),w=i.useMemo(()=>{var d;if(!t||!n||n.role!=="staff")return!1;const r=((d=t.staffId)==null?void 0:d._id)||t.staffId,s=n._id||n.id;if(!r||!s)return!1;try{return String(r)===String(s)}catch{return!1}},[t,n]),S=i.useMemo(()=>{var d;if(!t||!n||n.role!=="hod")return!1;const r=((d=t.hodId)==null?void 0:d._id)||t.hodId,s=n._id||n.id;if(!r||!s)return!1;try{return String(r)===String(s)}catch{return!1}},[t,n]),j=(n==null?void 0:n.role)==="staff"&&w,J=i.useMemo(()=>H(t),[t]);return v?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:a("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e("p",{className:"text-gray-600",children:"Loading marksheet..."})]})}):b||!t?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:a("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Not Found"}),e("p",{className:"text-gray-600",children:b||"Marksheet not found"}),e("button",{onClick:()=>x(-1),className:"mt-6 px-5 py-2 bg-blue-600 text-white rounded-lg",children:"Go Back"})]})}):e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:e("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:a("div",{className:"max-w-4xl mx-auto",children:[a("div",{className:"text-center mb-12",children:[e("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Marksheet Details"}),a("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["View, verify, and manage individual student marksheet details.",e("br",{}),"Track pass/fail/absent outcomes, dispatch status, and update student information as needed."]})]}),a("div",{className:"glass-card p-8 rounded-3xl transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[a("div",{className:"flex items-center justify-between mb-6",children:[e("h2",{className:"text-3xl font-bold text-gray-900",children:(k=t.studentDetails)==null?void 0:k.name}),e("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${c.className}`,children:c.label.toUpperCase()})]}),a("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[a("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Student"}),o?a("div",{className:"space-y-3",children:[a("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Name"}),e("input",{value:y.studentDetails.name||"",onChange:r=>p(s=>({...s,studentDetails:{...s.studentDetails,name:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),a("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Reg No"}),e("input",{value:y.studentDetails.regNumber||"",onChange:r=>p(s=>({...s,studentDetails:{...s.studentDetails,regNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),a("div",{className:"grid grid-cols-2 gap-3",children:[a("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Year"}),e("input",{value:y.studentDetails.year||"",onChange:r=>p(s=>({...s,studentDetails:{...s.studentDetails,year:r.target.value}})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., II"})]}),a("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Semester"}),e("input",{value:y.semester||y.studentDetails.semester||"",onChange:r=>p(s=>({...s,semester:r.target.value})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., 1"})]})]}),a("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Department"}),e("input",{value:y.studentDetails.department||"",onChange:r=>p(s=>({...s,studentDetails:{...s.studentDetails,department:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),a("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Parent Phone"}),e("input",{value:y.studentDetails.parentPhoneNumber||"",onChange:r=>p(s=>({...s,studentDetails:{...s.studentDetails,parentPhoneNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]})]}):a(D,{children:[a("p",{className:"text-gray-700",children:[e("strong",{children:"Reg No:"})," ",(R=t.studentDetails)==null?void 0:R.regNumber]}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Year/Sem:"})," ",(_=t.studentDetails)==null?void 0:_.year,"/",t.semester||((C=t.studentDetails)==null?void 0:C.semester)||"N/A"]}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Department:"})," ",(I=t.studentDetails)==null?void 0:I.department]}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Parent:"})," ",(M=t.studentDetails)==null?void 0:M.parentPhoneNumber]})]})]}),a("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Summary"}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Name:"})," ",t.examinationName||"N/A"]}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Date:"})," ",t.examinationDate?new Date(t.examinationDate).toLocaleString("default",{month:"long",year:"numeric"}):"N/A"]}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Overall Result:"})," ",J]}),a("p",{className:"text-gray-700",children:[e("strong",{children:"Staff:"})," ",t.staffName]}),t.hodName&&a("p",{className:"text-gray-700",children:[e("strong",{children:"HOD:"})," ",t.hodName]}),t.status==="approved_by_hod"&&((E=t.dispatchRequest)==null?void 0:E.respondedAt)&&a("p",{className:"text-gray-700",children:[e("strong",{children:"Approved On:"})," ",new Date(t.dispatchRequest.respondedAt).toLocaleString()]})]})]}),(((O=t.dispatchRequest)==null?void 0:O.hodResponse)||((P=t.dispatchRequest)==null?void 0:P.scheduledDispatchDate))&&a("div",{className:"mt-6 bg-white p-6 rounded-xl border border-gray-200",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Dispatch Notes"}),a("dl",{className:"space-y-2 text-gray-700",children:[((q=t.dispatchRequest)==null?void 0:q.hodResponse)&&a("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"HOD Decision"}),e("dd",{className:"capitalize",children:t.dispatchRequest.hodResponse})]}),((A=t.dispatchRequest)==null?void 0:A.hodComments)&&a("div",{children:[e("dt",{className:"font-medium",children:"Comments"}),e("dd",{className:"text-gray-700 mt-1",children:t.dispatchRequest.hodComments})]}),((F=t.dispatchRequest)==null?void 0:F.scheduledDispatchDate)&&a("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"Scheduled Dispatch"}),e("dd",{children:new Date(t.dispatchRequest.scheduledDispatchDate).toLocaleString()})]})]})]}),a("div",{className:"mt-8 bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Subjects"}),o?e("div",{className:"space-y-3",children:y.subjects.map((r,s)=>a("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e("input",{value:r.subjectName,onChange:d=>p(g=>{const m=[...g.subjects];return m[s]={...m[s],subjectName:d.target.value},{...g,subjects:m}}),className:"border rounded-lg px-3 py-2"}),e("input",{type:"number",value:r.marks,onChange:d=>p(g=>{const m=[...g.subjects];return m[s]={...m[s],marks:Number(d.target.value)},{...g,subjects:m}}),className:"border rounded-lg px-3 py-2"}),a("select",{value:r.result||"",onChange:d=>p(g=>{const m=[...g.subjects];return m[s]={...m[s],result:d.target.value},{...g,subjects:m}}),className:"border rounded-lg px-3 py-2",children:[e("option",{value:"",children:"Select Result"}),e("option",{value:"Pass",children:"Pass"}),e("option",{value:"Fail",children:"Fail"}),e("option",{value:"Absent",children:"Absent"})]})]},s))}):e("div",{className:"divide-y divide-gray-100",children:(t.subjects||[]).map((r,s)=>a("div",{className:"py-3 space-y-1 sm:space-y-0 sm:grid sm:grid-cols-2 sm:items-center",children:[e("span",{className:"text-gray-800 break-words min-w-0",children:r.subjectName}),a("div",{className:"flex items-center justify-between sm:justify-end gap-2 text-gray-700",children:[e("span",{className:"font-semibold",children:r.marks??"—"}),a("span",{className:"whitespace-nowrap",children:["Result: ",$(r)]})]})]},s))})]}),a("div",{className:"mt-8 flex flex-col sm:flex-row gap-3",children:[e("button",{onClick:()=>x(-1),className:"px-5 py-2 bg-gray-100 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Back"}),!o&&j&&a(D,{children:[e(B,{marksheet:t,onVerified:u}),e("button",{onClick:()=>N(!0),className:"px-5 py-2 bg-blue-600 text-white rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Edit & Regenerate"})]}),!o&&(j||S)&&a("div",{className:"flex gap-2 w-full sm:w-auto",children:[e(U,{id:t._id,onRefreshed:u}),e("button",{onClick:r=>{r.preventDefault();const s=Date.now(),d=window.location.origin,g=d?`${d}/api/generate-pdf?marksheetId=${t._id}&t=${s}`:`/api/generate-pdf?marksheetId=${t._id}&t=${s}`;window.open(g,"_blank")},className:"px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto bg-yellow-600 text-white",children:"Download PDF"})]}),o&&j&&a(D,{children:[e("button",{onClick:()=>N(!1),className:"px-5 py-2 bg-gray-200 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Cancel"}),e(z,{id:t._id,form:y,onSaved:r=>{u(r),N(!1)}})]})]})]})]})})})}function B({marksheet:l,onVerified:x}){const[t,u]=i.useState(!1),[v,f]=i.useState(""),[b,h]=i.useState(!1),[o]=i.useState(()=>{try{const n=localStorage.getItem("auth");return n?JSON.parse(n):null}catch{return null}});i.useEffect(()=>{(l==null?void 0:l.status)==="verified_by_staff"||(l==null?void 0:l.status)==="approved_by_hod"||(l==null?void 0:l.status)==="dispatched"?h(!0):h(!1)},[l]);const N=["approved_by_hod","rejected_by_hod","dispatched","rescheduled_by_hod"],{showError:y}=V(),p=async()=>{let n=o;try{const c=localStorage.getItem("auth");c&&(n=JSON.parse(c))}catch(c){console.error("Error refreshing user data:",c)}if(!(n!=null&&n.eSignature)){const c=(n==null?void 0:n._id)||(n==null?void 0:n.id)||localStorage.getItem("userId");if(c)try{const w=await fetch(`/api/users?action=profile&userId=${c}`),S=await w.json();w.ok&&S.success&&S.user&&(n={...n,...S.user},localStorage.setItem("auth",JSON.stringify(n)))}catch(w){console.error("Error fetching user profile:",w)}}u(!0),f("");try{const c=(n==null?void 0:n.eSignature)||null;if(!c){try{y("Signature Missing","Please add your signature in Settings before verifying this marksheet")}catch{}u(!1);return}const w=await fetch("/api/marksheets?action=verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c?{marksheetId:l._id,staffSignature:c}:{marksheetId:l._id})}),S=await w.json();!w.ok||!S.success?f(S.error||"Verification failed"):(h(!0),x(S.marksheet))}catch(c){f(c.message||"Unexpected error")}finally{u(!1)}};return a(D,{children:[e("button",{disabled:t||b||N.includes(l==null?void 0:l.status),onClick:p,className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${b||N.includes(l==null?void 0:l.status)?"bg-green-200 text-green-900 cursor-not-allowed":t?"bg-green-200 text-green-900":"bg-green-600 text-white"}`,children:b?"Verified":t?"Verifying...":"Verify"}),v&&e("span",{className:"text-red-600 text-sm ml-2",children:v})]})}function z({id:l,form:x,onSaved:t}){const[u,v]=i.useState(!1),[f,b]=i.useState("");return a(D,{children:[e("button",{disabled:u,onClick:async()=>{v(!0),b("");try{const o=await fetch("/api/marksheets",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:l,studentDetails:x.studentDetails,subjects:x.subjects,regenerateSignatures:!0})}),N=await o.json();!o.ok||!N.success?b(N.error||"Save failed"):t(N.marksheet)}catch(o){b(o.message||"Unexpected error")}finally{v(!1)}},className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${u?"bg-blue-200 text-blue-900":"bg-blue-600 text-white"}`,children:u?"Saving...":"Save Changes"}),f&&e("span",{className:"text-red-600 text-sm ml-2",children:f})]})}function U({id:l,onRefreshed:x}){const[t,u]=i.useState(!1),{showSuccess:v,showError:f}=V();return e("button",{onClick:async()=>{u(!0);try{const h=await fetch("/api/marksheets",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:l,regenerateSignatures:!0})}),o=await h.json();!h.ok||!o.success?f("Refresh Failed",o.error||"Could not refresh signatures"):(v("Signatures Refreshed","Staff/HOD signatures were updated on this marksheet"),typeof x=="function"&&x(o.marksheet))}catch(h){f("Refresh Failed",h.message||"Unexpected error")}finally{u(!1)}},disabled:t,className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${t?"bg-gray-200 text-gray-800":"bg-indigo-600 text-white"}`,children:t?"Refreshing...":"Refresh Signatures"})}export{Q as default};
