import{j as e,a as t,F as D}from"./index-d35fa7e7.js";import{f as L,u as U,r as o}from"./react-vendor-07fa9950.js";import{d as H,a as V}from"./resultUtils-190b400a.js";function Y(){var j,R,k,_,C,I,O,E,M,P,q,A;const{id:l}=L(),x=U(),[a,g]=o.useState(null),[N,p]=o.useState(!0),[b,y]=o.useState(""),[u,f]=o.useState(!1),[m,n]=o.useState({studentDetails:{},subjects:[]}),[d]=o.useState(()=>{try{const r=localStorage.getItem("auth");return r?JSON.parse(r):null}catch{return null}});o.useEffect(()=>{(async()=>{if(!l||l==="undefined"||l==="null"){y("Invalid marksheet id"),p(!1);return}try{const s=await fetch(`/api/marksheets?marksheetId=${encodeURIComponent(l)}`),i=await s.json();!s.ok||!i.success||!i.marksheet?y(i.error||"Failed to load marksheet"):(g(i.marksheet),i.marksheet&&n({studentDetails:{...i.marksheet.studentDetails||{}},subjects:Array.isArray(i.marksheet.subjects)?i.marksheet.subjects.map(h=>{const c=V(h);return{...h,result:c==="—"?"Pass":c}}):[]}))}catch(s){y(s.message||"Unexpected error")}finally{p(!1)}})()},[l]);const v=o.useMemo(()=>{const r=(a==null?void 0:a.status)||"unknown",s={draft:{label:"Draft",className:"bg-gray-100 text-gray-800"},verified_by_staff:{label:"Verified by Staff",className:"bg-green-100 text-green-800"},dispatch_requested:{label:"Dispatch Requested",className:"bg-yellow-100 text-yellow-800"},rescheduled_by_hod:{label:"Rescheduled by HOD",className:"bg-orange-100 text-orange-800"},approved_by_hod:{label:"Approved by HOD",className:"bg-blue-100 text-blue-800"},rejected_by_hod:{label:"Rejected by HOD",className:"bg-red-100 text-red-800"},dispatched:{label:"Dispatched",className:"bg-purple-100 text-purple-800"},unknown:{label:"Unknown",className:"bg-gray-200 text-gray-700"}};return s[r]||s.unknown},[a]),w=o.useMemo(()=>{var i;if(!a||!d||d.role!=="staff")return!1;const r=((i=a.staffId)==null?void 0:i._id)||a.staffId,s=d._id||d.id;if(!r||!s)return!1;try{return String(r)===String(s)}catch{return!1}},[a,d]),S=(d==null?void 0:d.role)==="staff"&&w,F=o.useMemo(()=>H(a),[a]);return N?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e("p",{className:"text-gray-600",children:"Loading marksheet..."})]})}):b||!a?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Not Found"}),e("p",{className:"text-gray-600",children:b||"Marksheet not found"}),e("button",{onClick:()=>x(-1),className:"mt-6 px-5 py-2 bg-blue-600 text-white rounded-lg",children:"Go Back"})]})}):e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:e("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:t("div",{className:"max-w-4xl mx-auto",children:[t("div",{className:"text-center mb-12",children:[e("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Marksheet Details"}),t("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["View, verify, and manage individual student marksheet details.",e("br",{}),"Track pass/fail/absent outcomes, dispatch status, and update student information as needed."]})]}),t("div",{className:"glass-card p-8 rounded-3xl transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[t("div",{className:"flex items-center justify-between mb-6",children:[e("h2",{className:"text-3xl font-bold text-gray-900",children:(j=a.studentDetails)==null?void 0:j.name}),e("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${v.className}`,children:v.label.toUpperCase()})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Student"}),u?t("div",{className:"space-y-3",children:[t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Name"}),e("input",{value:m.studentDetails.name||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,name:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Reg No"}),e("input",{value:m.studentDetails.regNumber||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,regNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{className:"grid grid-cols-2 gap-3",children:[t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Year"}),e("input",{value:m.studentDetails.year||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,year:r.target.value}})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., II"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Semester"}),e("input",{value:m.semester||m.studentDetails.semester||"",onChange:r=>n(s=>({...s,semester:r.target.value})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., 1"})]})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Department"}),e("input",{value:m.studentDetails.department||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,department:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Parent Phone"}),e("input",{value:m.studentDetails.parentPhoneNumber||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,parentPhoneNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]})]}):t(D,{children:[t("p",{className:"text-gray-700",children:[e("strong",{children:"Reg No:"})," ",(R=a.studentDetails)==null?void 0:R.regNumber]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Year/Sem:"})," ",(k=a.studentDetails)==null?void 0:k.year,"/",a.semester||((_=a.studentDetails)==null?void 0:_.semester)||"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Department:"})," ",(C=a.studentDetails)==null?void 0:C.department]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Parent:"})," ",(I=a.studentDetails)==null?void 0:I.parentPhoneNumber]})]})]}),t("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Summary"}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Name:"})," ",a.examinationName||"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Date:"})," ",a.examinationDate?new Date(a.examinationDate).toLocaleString("default",{month:"long",year:"numeric"}):"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Overall Result:"})," ",F]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Staff:"})," ",a.staffName]}),a.hodName&&t("p",{className:"text-gray-700",children:[e("strong",{children:"HOD:"})," ",a.hodName]}),a.status==="approved_by_hod"&&((O=a.dispatchRequest)==null?void 0:O.respondedAt)&&t("p",{className:"text-gray-700",children:[e("strong",{children:"Approved On:"})," ",new Date(a.dispatchRequest.respondedAt).toLocaleString()]})]})]}),(((E=a.dispatchRequest)==null?void 0:E.hodResponse)||((M=a.dispatchRequest)==null?void 0:M.scheduledDispatchDate))&&t("div",{className:"mt-6 bg-white p-6 rounded-xl border border-gray-200",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Dispatch Notes"}),t("dl",{className:"space-y-2 text-gray-700",children:[((P=a.dispatchRequest)==null?void 0:P.hodResponse)&&t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"HOD Decision"}),e("dd",{className:"capitalize",children:a.dispatchRequest.hodResponse})]}),((q=a.dispatchRequest)==null?void 0:q.hodComments)&&t("div",{children:[e("dt",{className:"font-medium",children:"Comments"}),e("dd",{className:"text-gray-700 mt-1",children:a.dispatchRequest.hodComments})]}),((A=a.dispatchRequest)==null?void 0:A.scheduledDispatchDate)&&t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"Scheduled Dispatch"}),e("dd",{children:new Date(a.dispatchRequest.scheduledDispatchDate).toLocaleString()})]})]})]}),t("div",{className:"mt-8 bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Subjects"}),u?e("div",{className:"space-y-3",children:m.subjects.map((r,s)=>t("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e("input",{value:r.subjectName,onChange:i=>n(h=>{const c=[...h.subjects];return c[s]={...c[s],subjectName:i.target.value},{...h,subjects:c}}),className:"border rounded-lg px-3 py-2"}),e("input",{type:"number",value:r.marks,onChange:i=>n(h=>{const c=[...h.subjects];return c[s]={...c[s],marks:Number(i.target.value)},{...h,subjects:c}}),className:"border rounded-lg px-3 py-2"}),t("select",{value:r.result||"",onChange:i=>n(h=>{const c=[...h.subjects];return c[s]={...c[s],result:i.target.value},{...h,subjects:c}}),className:"border rounded-lg px-3 py-2",children:[e("option",{value:"",children:"Select Result"}),e("option",{value:"Pass",children:"Pass"}),e("option",{value:"Fail",children:"Fail"}),e("option",{value:"Absent",children:"Absent"})]})]},s))}):e("div",{className:"divide-y divide-gray-100",children:(a.subjects||[]).map((r,s)=>t("div",{className:"py-3 space-y-1 sm:space-y-0 sm:grid sm:grid-cols-2 sm:items-center",children:[e("span",{className:"text-gray-800 break-words min-w-0",children:r.subjectName}),t("div",{className:"flex items-center justify-between sm:justify-end gap-2 text-gray-700",children:[e("span",{className:"font-semibold",children:r.marks??"—"}),t("span",{className:"whitespace-nowrap",children:["Result: ",V(r)]})]})]},s))})]}),t("div",{className:"mt-8 flex flex-col sm:flex-row gap-3",children:[e("button",{onClick:()=>x(-1),className:"px-5 py-2 bg-gray-100 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Back"}),!u&&S&&t(D,{children:[e(J,{marksheet:a,onVerified:g}),e("button",{onClick:()=>f(!0),className:"px-5 py-2 bg-blue-600 text-white rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Edit & Regenerate"})]}),u&&S&&t(D,{children:[e("button",{onClick:()=>f(!1),className:"px-5 py-2 bg-gray-200 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Cancel"}),e(T,{id:a._id,form:m,onSaved:r=>{g(r),f(!1)}})]})]})]})]})})})}function J({marksheet:l,onVerified:x}){const[a,g]=o.useState(!1),[N,p]=o.useState(""),[b,y]=o.useState(!1),[u]=o.useState(()=>{try{const n=localStorage.getItem("auth");return n?JSON.parse(n):null}catch{return null}});o.useEffect(()=>{(l==null?void 0:l.status)==="verified_by_staff"||(l==null?void 0:l.status)==="approved_by_hod"||(l==null?void 0:l.status)==="dispatched"?y(!0):y(!1)},[l]);const f=["approved_by_hod","rejected_by_hod","dispatched","rescheduled_by_hod"],m=async()=>{let n=u;try{const d=localStorage.getItem("auth");d&&(n=JSON.parse(d))}catch(d){console.error("Error refreshing user data:",d)}if(!(n!=null&&n.eSignature)){p("Please upload your signature in Settings before verifying marksheets");return}g(!0),p("");try{const d=n.eSignature,v=await fetch("/api/marksheets?action=verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:l._id,staffSignature:d})}),w=await v.json();!v.ok||!w.success?p(w.error||"Verification failed"):(y(!0),x(w.marksheet))}catch(d){p(d.message||"Unexpected error")}finally{g(!1)}};return t(D,{children:[e("button",{disabled:a||b||f.includes(l==null?void 0:l.status),onClick:m,className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${b||f.includes(l==null?void 0:l.status)?"bg-green-200 text-green-900 cursor-not-allowed":a?"bg-green-200 text-green-900":"bg-green-600 text-white"}`,children:b?"Verified":a?"Verifying...":"Verify"}),N&&e("span",{className:"text-red-600 text-sm ml-2",children:N})]})}function T({id:l,form:x,onSaved:a}){const[g,N]=o.useState(!1),[p,b]=o.useState("");return t(D,{children:[e("button",{disabled:g,onClick:async()=>{N(!0),b("");try{const u=await fetch("/api/marksheets",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:l,studentDetails:x.studentDetails,subjects:x.subjects})}),f=await u.json();!u.ok||!f.success?b(f.error||"Save failed"):a(f.marksheet)}catch(u){b(u.message||"Unexpected error")}finally{N(!1)}},className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${g?"bg-blue-200 text-blue-900":"bg-blue-600 text-white"}`,children:g?"Saving...":"Save Changes"}),p&&e("span",{className:"text-red-600 text-sm ml-2",children:p})]})}export{Y as default};
