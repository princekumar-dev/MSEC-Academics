import{u as G,j as t,a as s,F as K}from"./index-d35fa7e7.js";import{r as l,u as X}from"./react-vendor-07fa9950.js";import{R as Y}from"./RefreshButton-82c2aed7.js";import{u as Z}from"./Confetti-eb26a331.js";import{H as ee}from"./ContextualHelp-7deaab06.js";function de(){const{showSuccess:_,showError:N,showWarning:h}=G(),{celebrate:R,ConfettiContainer:$}=Z(),[n,k]=l.useState(()=>{try{const e=localStorage.getItem("auth");return e?JSON.parse(e):null}catch(e){return console.error("Failed to parse auth data:",e),null}}),[i,q]=l.useState([]),[S,v]=l.useState(!0),[w,P]=l.useState("all"),[d,D]=l.useState({open:!1,type:null,marksheet:null}),[A,c]=l.useState(!1),[p,g]=l.useState(""),[I,L]=l.useState(""),[f,O]=l.useState(!1),[U,B]=l.useState(!1),H=X();l.useEffect(()=>{(n==null?void 0:n.role)==="hod"?C():v(!1)},[n]);const C=async()=>{if(n){v(!0);try{console.log("[ApprovalRequests] Fetching with department:",n.department);const r=await(await fetch(`/api/marksheets?department=${n.department}&status=dispatch_requested,rescheduled_by_hod`)).json();console.log("[ApprovalRequests] Response:",r),r.success?q(r.marksheets):q([])}catch(e){console.error("Error fetching pending requests:",e),q([])}finally{v(!1)}}},J=async()=>{B(!0);try{await C()}finally{B(!1)}},F=(e,r)=>{g(""),D({open:!0,type:r,marksheet:e})},M=()=>{D({open:!1,type:null,marksheet:null}),g("")},z=async({comments:e,scheduledDispatchDate:r})=>{var a,x;if(!(!d.marksheet||!d.type))try{c(!0);const o=n._id||n.id,u=await fetch("/api/marksheets?action=hod-response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:d.marksheet._id,hodId:o,response:d.type,comments:e,scheduledDispatchDate:r})}),y=await u.json();if(!u.ok||!y.success)throw new Error(y.error||"Failed to submit response");const m=d.type==="approved"?"approved":d.type==="rejected"?"rejected":"rescheduled",j=((x=(a=d.marksheet)==null?void 0:a.studentDetails)==null?void 0:x.name)||"Student";L(`Dispatch request ${m} successfully.`),d.type==="approved"?_("âœ“ Approved",`Dispatch approved for ${j}`):d.type==="rejected"?h("Request Rejected",`Dispatch rejected for ${j}`):_("Rescheduled",`Dispatch rescheduled for ${j}`),M(),await C()}catch(o){g(o.message||"Unexpected error"),N("Action Failed",o.message||"Could not process the request")}finally{c(!1)}},E=async e=>{const r=b.filter(a=>a.status==="dispatch_requested"||a.status==="rescheduled_by_hod");if(r.length===0){L(`No pending requests available for bulk ${e}.`);return}try{O(!0),g("");const a=n._id||n.id,x=r.map(m=>fetch("/api/marksheets?action=hod-response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:m._id,hodId:a,response:e,comments:"",scheduledDispatchDate:null})}).then(j=>j.json())),o=await Promise.all(x),u=o.filter(m=>m.success).length,y=o.length-u;if(u>0){const m=`Successfully ${e} ${u} request${u>1?"s":""}.${y>0?` ${y} failed.`:""}`;L(m),_(`Bulk ${e.charAt(0).toUpperCase()+e.slice(1)}`,`${u}/${o.length} requests processed successfully`),y===0&&R()}else{const m=`Failed to ${e.slice(0,-1)} any requests. Please try again.`;g(m),N("Bulk Action Failed",m)}await C()}catch(a){g(a.message||`Failed to perform bulk ${e}`)}finally{O(!1)}},T=l.useMemo(()=>[{id:"all",label:"All",count:i.length},{id:"dispatch_requested",label:"Pending",count:i.filter(e=>e.status==="dispatch_requested").length},{id:"rescheduled_by_hod",label:"Rescheduled",count:i.filter(e=>e.status==="rescheduled_by_hod").length}],[i]),b=l.useMemo(()=>(w==="all"?i:i.filter(r=>r.status===w)).sort((r,a)=>{var u,y;const x=(((u=r.studentDetails)==null?void 0:u.regNumber)||"").toString().toLowerCase(),o=(((y=a.studentDetails)==null?void 0:y.regNumber)||"").toString().toLowerCase();return x.localeCompare(o,void 0,{numeric:!0,sensitivity:"base"})}),[i,w]),V={dispatch_requested:"bg-yellow-100 text-yellow-800",rescheduled_by_hod:"bg-orange-100 text-orange-800",approved_by_hod:"bg-green-100 text-green-800",rejected_by_hod:"bg-red-100 text-red-800",dispatched:"bg-purple-100 text-purple-800"},W={dispatch_requested:"â³",rescheduled_by_hod:"ðŸ”„",approved_by_hod:"âœ…",rejected_by_hod:"â›”",dispatched:"ðŸ“¤"},Q=(e={})=>{const r=(e.year||"").toString(),a=(e.section||"").toString();return!r&&!a?"N/A":a?r?`${r}-${a}`:a:r};return!n||n.role!=="hod"?t("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:s("div",{className:"glass-card p-8 rounded-3xl text-center",children:[t("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),t("p",{className:"text-gray-600",children:"Only HODs can approve dispatch requests."})]})}):s("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:[t("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:s("div",{className:"max-w-6xl mx-auto",children:[s("div",{className:"text-center mb-8",children:[t("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Approval Requests"}),s("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["Review and approve dispatch requests for ",n.department," Department"]})]}),t("div",{className:"glass-card p-4 sm:p-6 md:p-8 rounded-2xl md:rounded-3xl mb-8",children:S?s("div",{className:"text-center py-12",children:[t("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),t("p",{className:"text-gray-600",children:"Loading pending requests..."})]}):i.length===0?s("div",{className:"text-center py-12",children:[t("svg",{className:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),t("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No pending requests"}),t("p",{className:"text-gray-600",children:"All dispatch requests have been processed"})]}):s(K,{children:[t("div",{className:"flex flex-wrap items-center gap-3 mb-6",children:T.map(e=>s("button",{onClick:()=>P(e.id),className:`px-4 py-2 rounded-full text-sm font-medium border transition-all duration-200 ${w===e.id?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:border-blue-400"}`,children:[e.label,t("span",{className:`ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-semibold ${w===e.id?"bg-white/25 text-white":"bg-gray-100 text-gray-700"}`,children:e.count})]},e.id))}),I&&t("div",{className:"mb-6 rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800",children:I}),p&&t("div",{className:"mb-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800",children:p}),s("div",{className:"mb-6 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100",children:[s("div",{className:"flex items-start justify-between gap-4 mb-3",children:[t("div",{className:"flex items-center gap-2",children:s("div",{children:[s("div",{className:"flex items-center gap-2",children:[t("h3",{className:"text-sm font-semibold text-gray-900",children:"Bulk Actions"}),t(ee,{content:"Quickly approve, reschedule, or reject all pending dispatch requests at once."})]}),s("p",{className:"text-xs text-gray-600",children:[b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length," pending requests available"]})]})}),t(Y,{isLoading:U,onClick:J})]}),s("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3",children:[t("button",{onClick:()=>E("approved"),disabled:f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0,className:`px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1 ${f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0?"bg-gray-300 cursor-not-allowed":"bg-green-600 hover:bg-green-700"}`,children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"âœ…"}),t("span",{children:f?"Processing...":"Approve All"})]})}),t("button",{onClick:()=>E("rescheduled"),disabled:f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0,className:`px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-1 ${f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0?"bg-gray-300 cursor-not-allowed":"bg-orange-500 hover:bg-orange-600"}`,children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"ðŸ”„"}),t("span",{children:f?"Processing...":"Reschedule All"})]})}),t("button",{onClick:()=>E("rejected"),disabled:f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0,className:`px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 ${f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0?"bg-gray-300 cursor-not-allowed":"bg-red-600 hover:bg-red-700"}`,children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"â›”"}),t("span",{children:f?"Processing...":"Reject All"})]})})]})]}),t("div",{className:"space-y-4",children:b.map(e=>{var r,a,x,o;return s("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[s("div",{className:"p-4 sm:p-6 pb-3 sm:pb-4",children:[s("div",{className:"flex items-start justify-between mb-3 gap-2",children:[s("div",{className:"flex-1 min-w-0",children:[t("h3",{className:"text-lg sm:text-xl font-bold text-gray-900 mb-1 truncate",children:(r=e.studentDetails)==null?void 0:r.name}),s("p",{className:"text-xs sm:text-sm text-gray-600",children:[(a=e.studentDetails)==null?void 0:a.regNumber," â€¢ ",Q(e.studentDetails)]})]}),s("span",{className:`px-2 py-1 sm:px-3 sm:py-1.5 rounded-full text-xs font-semibold uppercase tracking-wide flex items-center gap-1 whitespace-nowrap ${V[e.status]||"bg-yellow-100 text-yellow-800"}`,children:[t("span",{className:"text-xs sm:text-sm",children:W[e.status]||"ðŸ“„"}),t("span",{className:"text-xs",children:(e.status||"").replace(/_/g," ")})]})]}),s("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6 text-xs sm:text-sm",children:[s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Staff:"}),t("p",{className:"font-medium text-gray-900 truncate",children:e.staffName||"demo staff"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Parent Phone:"}),t("p",{className:"font-medium text-gray-900",children:((x=e.studentDetails)==null?void 0:x.parentPhoneNumber)||"â€”"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Exam Date:"}),t("p",{className:"font-medium text-gray-900",children:e.examinationDate?new Date(e.examinationDate).toLocaleDateString("en-US",{month:"short",year:"numeric"}):"â€”"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Subjects:"}),t("p",{className:"font-medium text-gray-900",children:((o=e.subjects)==null?void 0:o.length)||0})]})]})]}),t("div",{className:"border-t border-gray-100"}),t("div",{className:"p-4 sm:p-6 pt-3 sm:pt-4 bg-gray-50",children:s("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3",children:[s("button",{onClick:()=>F(e,"approved"),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-green-600 hover:bg-green-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1",children:[t("span",{className:"hidden sm:inline",children:"Approve Dispatch"}),t("span",{className:"sm:hidden",children:"Approve"})]}),s("button",{onClick:()=>F(e,"rejected"),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-red-600 hover:bg-red-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1",children:[t("span",{className:"hidden sm:inline",children:"Reject Request"}),t("span",{className:"sm:hidden",children:"Reject"})]}),t("button",{onClick:()=>F(e,"rescheduled"),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs sm:text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-1",children:"Reschedule"}),s("button",{onClick:()=>H(`/marksheets/${e._id||e.marksheetId}`),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-white hover:bg-gray-50 text-gray-700 text-xs sm:text-sm font-medium rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1",children:[t("span",{className:"hidden sm:inline",children:"View Details"}),t("span",{className:"sm:hidden",children:"Details"})]})]})}),t("div",{className:"my-6 border-t border-dashed border-gray-300"})]},e._id)})})]})})]})}),t(te,{open:d.open,type:d.type,marksheet:d.marksheet,onClose:M,onSubmit:z,loading:A,error:p}),t($,{})]})}function te({open:_,type:N,marksheet:h,onClose:R,onSubmit:$,loading:n,error:k}){var D,A;const[i,q]=l.useState(""),[S,v]=l.useState("");if(l.useEffect(()=>{var c;if(!(!_||!h))if(q(""),(c=h.dispatchRequest)!=null&&c.scheduledDispatchDate){const p=new Date(h.dispatchRequest.scheduledDispatchDate);Number.isNaN(p.getTime())?v(""):v(p.toISOString().slice(0,16))}else v("")},[_,N,h]),!_||!h)return null;const w=N==="rescheduled",P=N==="approved"?"Approve dispatch request":N==="rejected"?"Reject dispatch request":"Reschedule dispatch request",d=c=>{c.preventDefault();const p={comments:i.trim()||void 0,scheduledDispatchDate:void 0};if(S){const g=new Date(S);Number.isNaN(g.getTime())||(p.scheduledDispatchDate=g.toISOString())}$(p)};return t("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:s("div",{className:"glass-card w-full max-w-lg p-6",children:[s("div",{className:"mb-4",children:[t("h3",{className:"text-xl font-semibold text-gray-900",children:P}),s("p",{className:"text-sm text-gray-600 mt-1",children:[(D=h.studentDetails)==null?void 0:D.name," â€¢ ",(A=h.studentDetails)==null?void 0:A.regNumber]})]}),s("form",{onSubmit:d,className:"space-y-4",children:[s("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Comments (optional)"}),t("textarea",{value:i,onChange:c=>q(c.target.value),rows:4,className:"w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:outline-none",placeholder:N==="rejected"?"Let the staff know the reason for rejection":"Add any notes for the staff member"})]}),s("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Schedule (optional)"}),t("input",{type:"datetime-local",value:S,onChange:c=>v(c.target.value),required:w,className:"w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:outline-none"}),w&&t("p",{className:"text-xs text-gray-500 mt-2",children:"Provide the new date/time for dispatch. This will be visible to the staff member."})]}),k&&t("div",{className:"rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:k}),s("div",{className:"flex justify-end gap-3 pt-2",children:[t("button",{type:"button",onClick:R,className:"px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-100",children:"Cancel"}),t("button",{type:"submit",disabled:n,className:`px-5 py-2 rounded-lg text-white ${n?"bg-blue-300 cursor-wait":"bg-blue-600 hover:bg-blue-700"}`,children:n?"Saving...":"Confirm"})]})]})]})})}export{de as default};
