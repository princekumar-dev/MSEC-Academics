import{j as e,a as t,F as S}from"./index-538465e6.js";import{f as J,u as L,r as o}from"./react-vendor-07fa9950.js";import{d as H,a as V}from"./resultUtils-190b400a.js";function G(){var j,R,k,_,C,I,E,O,M,P,q,A;const{id:n}=J(),v=L(),[a,g]=o.useState(null),[w,p]=o.useState(!0),[f,N]=o.useState(""),[u,b]=o.useState(!1),[m,r]=o.useState({studentDetails:{},subjects:[]}),[d]=o.useState(()=>{try{const l=localStorage.getItem("auth");return l?JSON.parse(l):null}catch{return null}});o.useEffect(()=>{(async()=>{if(!n||n==="undefined"||n==="null"){N("Invalid marksheet id"),p(!1);return}try{const s=await fetch(`/api/marksheets?marksheetId=${encodeURIComponent(n)}`),i=await s.json();!s.ok||!i.success||!i.marksheet?N(i.error||"Failed to load marksheet"):(g(i.marksheet),i.marksheet&&r({studentDetails:{...i.marksheet.studentDetails||{}},subjects:Array.isArray(i.marksheet.subjects)?i.marksheet.subjects.map(h=>{const c=V(h);return{...h,result:c==="—"?"Pass":c}}):[]}))}catch(s){N(s.message||"Unexpected error")}finally{p(!1)}})()},[n]);const y=o.useMemo(()=>{const l=(a==null?void 0:a.status)||"unknown",s={draft:{label:"Draft",className:"bg-gray-100 text-gray-800"},verified_by_staff:{label:"Verified by Staff",className:"bg-green-100 text-green-800"},dispatch_requested:{label:"Dispatch Requested",className:"bg-yellow-100 text-yellow-800"},rescheduled_by_hod:{label:"Rescheduled by HOD",className:"bg-orange-100 text-orange-800"},approved_by_hod:{label:"Approved by HOD",className:"bg-blue-100 text-blue-800"},rejected_by_hod:{label:"Rejected by HOD",className:"bg-red-100 text-red-800"},dispatched:{label:"Dispatched",className:"bg-purple-100 text-purple-800"},unknown:{label:"Unknown",className:"bg-gray-200 text-gray-700"}};return s[l]||s.unknown},[a]),x=o.useMemo(()=>{var i;if(!a||!d||d.role!=="staff")return!1;const l=((i=a.staffId)==null?void 0:i._id)||a.staffId,s=d._id||d.id;if(!l||!s)return!1;try{return String(l)===String(s)}catch{return!1}},[a,d]),D=(d==null?void 0:d.role)==="staff"&&x,F=o.useMemo(()=>H(a),[a]);return w?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e("p",{className:"text-gray-600",children:"Loading marksheet..."})]})}):f||!a?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Not Found"}),e("p",{className:"text-gray-600",children:f||"Marksheet not found"}),e("button",{onClick:()=>v(-1),className:"mt-6 px-5 py-2 bg-blue-600 text-white rounded-lg",children:"Go Back"})]})}):e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:e("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:t("div",{className:"max-w-4xl mx-auto",children:[t("div",{className:"text-center mb-12",children:[e("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Marksheet Details"}),t("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["View, verify, and manage individual student marksheet details.",e("br",{}),"Track pass/fail/absent outcomes, dispatch status, and update student information as needed."]})]}),t("div",{className:"glass-card p-8 rounded-3xl transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[t("div",{className:"flex items-center justify-between mb-6",children:[e("h2",{className:"text-3xl font-bold text-gray-900",children:(j=a.studentDetails)==null?void 0:j.name}),e("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${y.className}`,children:y.label.toUpperCase()})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Student"}),u?t("div",{className:"space-y-3",children:[t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Name"}),e("input",{value:m.studentDetails.name||"",onChange:l=>r(s=>({...s,studentDetails:{...s.studentDetails,name:l.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Reg No"}),e("input",{value:m.studentDetails.regNumber||"",onChange:l=>r(s=>({...s,studentDetails:{...s.studentDetails,regNumber:l.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{className:"grid grid-cols-2 gap-3",children:[t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Year"}),e("input",{value:m.studentDetails.year||"",onChange:l=>r(s=>({...s,studentDetails:{...s.studentDetails,year:l.target.value}})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., II"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Semester"}),e("input",{value:m.semester||m.studentDetails.semester||"",onChange:l=>r(s=>({...s,semester:l.target.value})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., 1"})]})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Department"}),e("input",{value:m.studentDetails.department||"",onChange:l=>r(s=>({...s,studentDetails:{...s.studentDetails,department:l.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Parent Phone"}),e("input",{value:m.studentDetails.parentPhoneNumber||"",onChange:l=>r(s=>({...s,studentDetails:{...s.studentDetails,parentPhoneNumber:l.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]})]}):t(S,{children:[t("p",{className:"text-gray-700",children:[e("strong",{children:"Reg No:"})," ",(R=a.studentDetails)==null?void 0:R.regNumber]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Year/Sem:"})," ",(k=a.studentDetails)==null?void 0:k.year,"/",a.semester||((_=a.studentDetails)==null?void 0:_.semester)||"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Department:"})," ",(C=a.studentDetails)==null?void 0:C.department]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Parent:"})," ",(I=a.studentDetails)==null?void 0:I.parentPhoneNumber]})]})]}),t("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Summary"}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Name:"})," ",a.examinationName||"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Date:"})," ",a.examinationDate?new Date(a.examinationDate).toLocaleString("default",{month:"long",year:"numeric"}):"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Overall Result:"})," ",F]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Staff:"})," ",a.staffName]}),a.hodName&&t("p",{className:"text-gray-700",children:[e("strong",{children:"HOD:"})," ",a.hodName]}),a.status==="approved_by_hod"&&((E=a.dispatchRequest)==null?void 0:E.respondedAt)&&t("p",{className:"text-gray-700",children:[e("strong",{children:"Approved On:"})," ",new Date(a.dispatchRequest.respondedAt).toLocaleString()]})]})]}),(((O=a.dispatchRequest)==null?void 0:O.hodResponse)||((M=a.dispatchRequest)==null?void 0:M.scheduledDispatchDate))&&t("div",{className:"mt-6 bg-white p-6 rounded-xl border border-gray-200",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Dispatch Notes"}),t("dl",{className:"space-y-2 text-gray-700",children:[((P=a.dispatchRequest)==null?void 0:P.hodResponse)&&t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"HOD Decision"}),e("dd",{className:"capitalize",children:a.dispatchRequest.hodResponse})]}),((q=a.dispatchRequest)==null?void 0:q.hodComments)&&t("div",{children:[e("dt",{className:"font-medium",children:"Comments"}),e("dd",{className:"text-gray-700 mt-1",children:a.dispatchRequest.hodComments})]}),((A=a.dispatchRequest)==null?void 0:A.scheduledDispatchDate)&&t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"Scheduled Dispatch"}),e("dd",{children:new Date(a.dispatchRequest.scheduledDispatchDate).toLocaleString()})]})]})]}),t("div",{className:"mt-8 bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Subjects"}),u?e("div",{className:"space-y-3",children:m.subjects.map((l,s)=>t("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e("input",{value:l.subjectName,onChange:i=>r(h=>{const c=[...h.subjects];return c[s]={...c[s],subjectName:i.target.value},{...h,subjects:c}}),className:"border rounded-lg px-3 py-2"}),e("input",{type:"number",value:l.marks,onChange:i=>r(h=>{const c=[...h.subjects];return c[s]={...c[s],marks:Number(i.target.value)},{...h,subjects:c}}),className:"border rounded-lg px-3 py-2"}),t("select",{value:l.result||"",onChange:i=>r(h=>{const c=[...h.subjects];return c[s]={...c[s],result:i.target.value},{...h,subjects:c}}),className:"border rounded-lg px-3 py-2",children:[e("option",{value:"",children:"Select Result"}),e("option",{value:"Pass",children:"Pass"}),e("option",{value:"Fail",children:"Fail"}),e("option",{value:"Absent",children:"Absent"})]})]},s))}):e("div",{className:"divide-y divide-gray-100",children:(a.subjects||[]).map((l,s)=>t("div",{className:"py-3 space-y-1 sm:space-y-0 sm:grid sm:grid-cols-2 sm:items-center",children:[e("span",{className:"text-gray-800 break-words min-w-0",children:l.subjectName}),t("div",{className:"flex items-center justify-between sm:justify-end gap-2 text-gray-700",children:[e("span",{className:"font-semibold",children:l.marks??"—"}),t("span",{className:"whitespace-nowrap",children:["Result: ",V(l)]})]})]},s))})]}),t("div",{className:"mt-8 flex flex-col sm:flex-row gap-3",children:[e("button",{onClick:()=>v(-1),className:"px-5 py-2 bg-gray-100 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Back"}),!u&&D&&t(S,{children:[e(T,{marksheet:a,onVerified:g}),e("button",{onClick:()=>b(!0),className:"px-5 py-2 bg-blue-600 text-white rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Edit & Regenerate"})]}),u&&D&&t(S,{children:[e("button",{onClick:()=>b(!1),className:"px-5 py-2 bg-gray-200 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Cancel"}),e($,{id:a._id,form:m,onSaved:l=>{g(l),b(!1)}})]})]})]})]})})})}function T({marksheet:n,onVerified:v}){const[a,g]=o.useState(!1),[w,p]=o.useState(""),[f,N]=o.useState(!1),[u]=o.useState(()=>{try{const r=localStorage.getItem("auth");return r?JSON.parse(r):null}catch{return null}});o.useEffect(()=>{(n==null?void 0:n.status)==="verified_by_staff"||(n==null?void 0:n.status)==="approved_by_hod"||(n==null?void 0:n.status)==="dispatched"?N(!0):N(!1)},[n]);const b=["approved_by_hod","rejected_by_hod","dispatched","rescheduled_by_hod"],m=async()=>{let r=u;try{const d=localStorage.getItem("auth");d&&(r=JSON.parse(d))}catch(d){console.error("Error refreshing user data:",d)}if(!(r!=null&&r.eSignature)){const d=(r==null?void 0:r._id)||(r==null?void 0:r.id)||localStorage.getItem("userId");if(d)try{const y=await fetch(`/api/users?action=profile&userId=${d}`),x=await y.json();y.ok&&x.success&&x.user&&(r={...r,...x.user},localStorage.setItem("auth",JSON.stringify(r)))}catch(y){console.error("Error fetching user profile:",y)}}if(!(r!=null&&r.eSignature)){p("Please upload your signature in Settings before verifying marksheets");return}g(!0),p("");try{const d=r.eSignature,y=await fetch("/api/marksheets?action=verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:n._id,staffSignature:d})}),x=await y.json();!y.ok||!x.success?p(x.error||"Verification failed"):(N(!0),v(x.marksheet))}catch(d){p(d.message||"Unexpected error")}finally{g(!1)}};return t(S,{children:[e("button",{disabled:a||f||b.includes(n==null?void 0:n.status),onClick:m,className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${f||b.includes(n==null?void 0:n.status)?"bg-green-200 text-green-900 cursor-not-allowed":a?"bg-green-200 text-green-900":"bg-green-600 text-white"}`,children:f?"Verified":a?"Verifying...":"Verify"}),w&&e("span",{className:"text-red-600 text-sm ml-2",children:w})]})}function $({id:n,form:v,onSaved:a}){const[g,w]=o.useState(!1),[p,f]=o.useState("");return t(S,{children:[e("button",{disabled:g,onClick:async()=>{w(!0),f("");try{const u=await fetch("/api/marksheets",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:n,studentDetails:v.studentDetails,subjects:v.subjects})}),b=await u.json();!u.ok||!b.success?f(b.error||"Save failed"):a(b.marksheet)}catch(u){f(u.message||"Unexpected error")}finally{w(!1)}},className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${g?"bg-blue-200 text-blue-900":"bg-blue-600 text-white"}`,children:g?"Saving...":"Save Changes"}),p&&e("span",{className:"text-red-600 text-sm ml-2",children:p})]})}export{G as default};
