import{j as s,a,F as R}from"./index-d35fa7e7.js";import{r as u}from"./react-vendor-07fa9950.js";import{R as Y}from"./RefreshButton-82c2aed7.js";const T={}.VITE_PUBLIC_BASE_URL||"https://academics-2-demo.onrender.com",U=()=>T?T.replace(/\/$/,""):typeof window<"u"?window.location.origin:"";function te(){const[i]=u.useState(()=>{const e=localStorage.getItem("auth");return e?JSON.parse(e):null}),[r,h]=u.useState([]),[L,y]=u.useState(!0),[_,$]=u.useState(!1),[m,I]=u.useState([]),[w,A]=u.useState(null),[v,C]=u.useState(!1),[b,E]=u.useState("all"),[N,f]=u.useState(""),[S,p]=u.useState(""),[F,j]=u.useState(!1);u.useEffect(()=>{(i==null?void 0:i.role)==="staff"?g():y(!1)},[i]);const g=async()=>{if(i){y(!0);try{const e=(i==null?void 0:i._id)||(i==null?void 0:i.id)||localStorage.getItem("userId"),n=await(await fetch(`/api/marksheets?staffId=${e}&status=verified_by_staff,dispatch_requested,rescheduled_by_hod,approved_by_hod,rejected_by_hod,dispatched`)).json();n.success?h(n.marksheets):h([])}catch(e){console.error("Error fetching marksheets:",e),h([])}finally{y(!1)}}},M=async()=>{j(!0);try{await g()}finally{j(!1)}},D=async e=>{try{return await(await fetch("/api/marksheets?action=request-dispatch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:e,staffId:i._id||i.id})})).json()}catch(t){return{success:!1,error:t.message}}},O=async e=>{f(""),p(""),I(t=>Array.from(new Set([...t,e])));try{const t=await D(e);t!=null&&t.success?(f("Dispatch request submitted for HOD approval."),h(n=>n.map(o=>o._id===e?{...o,status:"dispatch_requested",dispatchRequest:{...o.dispatchRequest||{},requestedAt:new Date().toISOString(),requestedBy:(i==null?void 0:i._id)||(i==null?void 0:i.id),hodResponse:null,hodComments:null,scheduledDispatchDate:null}}:o))):p((t==null?void 0:t.error)||"Failed to request dispatch")}catch(t){console.error(t),p("Unexpected error while requesting dispatch")}finally{I(t=>t.filter(n=>n!==e)),g()}},W=async()=>{const e=r.filter(t=>t.status==="verified_by_staff");if(e.length!==0){f(""),p(""),$(!0);try{const t=[];for(const l of e){const d=await D(l._id);t.push(d)}const n=t.filter(l=>l==null?void 0:l.success).length,o=t.length-n;n>0&&f(`Submitted ${n} dispatch request${n>1?"s":""} for approval.`),o>0&&p(`Failed to submit ${o} request${o>1?"s":""}. Please try again.`)}finally{$(!1),g()}}},B=async e=>{if(e!=null&&e._id){f(""),p(""),A(e._id);try{const t=U(),n=t?`${t}/api/generate-pdf?marksheetId=${e._id}`:"",o=t?`${t}/api/generate-pdf?marksheetId=${e._id}&format=jpeg`:"",l=await fetch("/api/whatsapp-dispatch?action=send-marksheet",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:e._id,marksheetPdfUrl:n,marksheetImageUrl:o})}),d=await l.json();if(!l.ok||!d.success){const c=d.details||d.error||"Failed to dispatch marksheet";throw c.includes("Authenticate")||c.includes("authentication")?new Error("Twilio authentication failed. Please verify TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN in .env file. See TWILIO_SETUP_GUIDE.md"):d.setupGuide?new Error(`${c}. ${d.setupGuide}`):new Error(c)}f("Marksheet dispatched to parent via WhatsApp."),h(c=>c.map(x=>x._id===e._id?{...x,status:"dispatched"}:x)),await g()}catch(t){console.error(t),p(t.message||"Unable to dispatch marksheet.")}finally{A(null)}}},H=async()=>{const e=r.filter(t=>t.status==="approved_by_hod");if(e.length!==0){f(""),p(""),C(!0);try{const t=U(),n=[];for(const d of e)try{const c=t?`${t}/api/generate-pdf?marksheetId=${d._id}`:"",x=t?`${t}/api/generate-pdf?marksheetId=${d._id}&format=jpeg`:"",k=await fetch("/api/whatsapp-dispatch?action=send-marksheet",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:d._id,marksheetPdfUrl:c,marksheetImageUrl:x})}),P=await k.json();k.ok&&P.success?(n.push({success:!0,id:d._id}),h(K=>K.map(q=>q._id===d._id?{...q,status:"dispatched"}:q))):n.push({success:!1,id:d._id,error:P.error})}catch(c){n.push({success:!1,id:d._id,error:c.message})}const o=n.filter(d=>d.success).length,l=n.length-o;o>0&&f(`Successfully sent ${o} marksheet${o>1?"s":""} via WhatsApp.`),l>0&&p(`Failed to send ${l} marksheet${l>1?"s":""}. Please try sending them individually.`)}catch(t){console.error(t),p("Unexpected error while sending marksheets via WhatsApp.")}finally{C(!1),await g()}}},J=u.useMemo(()=>[{id:"all",label:"All",count:r.length},{id:"verified_by_staff",label:"Ready",count:r.filter(e=>e.status==="verified_by_staff").length},{id:"dispatch_requested",label:"Pending",count:r.filter(e=>e.status==="dispatch_requested").length},{id:"rescheduled_by_hod",label:"Rescheduled",count:r.filter(e=>e.status==="rescheduled_by_hod").length},{id:"approved_by_hod",label:"Approved",count:r.filter(e=>e.status==="approved_by_hod").length},{id:"rejected_by_hod",label:"Rejected",count:r.filter(e=>e.status==="rejected_by_hod").length},{id:"dispatched",label:"Dispatched",count:r.filter(e=>e.status==="dispatched").length}],[r]),G=u.useMemo(()=>(b==="all"?r:r.filter(t=>t.status===b)).sort((t,n)=>{var d,c;const o=(((d=t.studentDetails)==null?void 0:d.regNumber)||"").toString().toLowerCase(),l=(((c=n.studentDetails)==null?void 0:c.regNumber)||"").toString().toLowerCase();return o.localeCompare(l,void 0,{numeric:!0,sensitivity:"base"})}),[r,b]),V={verified_by_staff:"bg-blue-100 text-blue-800",dispatch_requested:"bg-yellow-100 text-yellow-800",rescheduled_by_hod:"bg-orange-100 text-orange-800",approved_by_hod:"bg-green-100 text-green-800",rejected_by_hod:"bg-red-100 text-red-800",dispatched:"bg-purple-100 text-purple-800"},z={verified_by_staff:"ðŸ“‹",dispatch_requested:"â³",rescheduled_by_hod:"ðŸ”„",approved_by_hod:"âœ…",rejected_by_hod:"â›”",dispatched:"ðŸ“¤"};return!i||i.role!=="staff"?s("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:a("div",{className:"glass-card p-8 rounded-3xl text-center",children:[s("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),s("p",{className:"text-gray-600",children:"Only staff members can manage dispatch requests."})]})}):s("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:s("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:a("div",{className:"max-w-6xl mx-auto",children:[a("div",{className:"text-center mb-8",children:[s("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Dispatch Requests"}),a("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["Submit and track WhatsApp dispatch requests for verified marksheets.",s("br",{}),"Request approval, send reports, and manage dispatch status for your students."]})]}),s("div",{className:"glass-card p-8 rounded-3xl mb-8",children:L?a("div",{className:"text-center py-12",children:[s("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),s("p",{className:"text-gray-600",children:"Loading verified marksheets..."})]}):r.length===0?a("div",{className:"text-center py-12",children:[s("svg",{className:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),s("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No marksheets available"}),s("p",{className:"text-gray-600",children:"Import and verify marksheets to begin requesting dispatch approvals."})]}):a(R,{children:[a("div",{className:"bg-blue-50 p-4 rounded-xl mb-6 text-blue-800",children:[s("strong",{children:"Tip:"})," Request dispatch after verifying marksheets. Once the HOD approves, you can send the report directly to parents via WhatsApp."]}),s("div",{className:"flex flex-wrap items-center gap-2 mb-6",children:J.map(e=>a("button",{onClick:()=>E(e.id),className:`px-3 py-2 rounded-full text-xs sm:text-sm font-medium border transition-colors duration-200 whitespace-nowrap ${b===e.id?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:border-yellow-400"}`,children:[e.label,s("span",{className:`ml-1 inline-flex items-center justify-center px-1.5 py-0.5 rounded-full text-xs font-semibold ${b===e.id?"bg-white/25 text-white":"bg-gray-100 text-gray-700"}`,children:e.count})]},e.id))}),(N||S)&&a("div",{className:"mb-6 space-y-2",children:[N&&s("div",{className:"rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800",children:N}),S&&s("div",{className:"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:S})]}),a("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 mb-6",children:[a("div",{className:"flex items-center gap-2 sm:gap-4 flex-wrap",children:[s("button",{onClick:W,disabled:_||r.every(e=>e.status!=="verified_by_staff"),className:`inline-flex items-center gap-2 px-4 sm:px-6 py-2 rounded-lg font-semibold whitespace-nowrap ${_||r.every(e=>e.status!=="verified_by_staff")?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"}`,children:_?"Requesting...":"ðŸ“‹ Request All"}),s("button",{onClick:H,disabled:v||r.every(e=>e.status!=="approved_by_hod"),className:`inline-flex items-center gap-2 px-4 sm:px-6 py-2 rounded-lg font-semibold whitespace-nowrap ${v||r.every(e=>e.status!=="approved_by_hod")?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 transition-colors"}`,children:v?a(R,{children:[s("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Sending..."]}):s(R,{children:"ðŸ“¤ Send All"})})]}),s("div",{className:"self-end sm:self-auto",children:s(Y,{isLoading:F,onClick:M})})]}),s("div",{className:"space-y-4",children:G.map(e=>{var t,n,o,l,d,c;return s("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-yellow-300",children:a("div",{className:"p-4 sm:p-6 pb-3 sm:pb-4",children:[a("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-4",children:[a("div",{className:"flex-1 min-w-0",children:[s("h3",{className:"text-lg sm:text-xl font-bold text-gray-900 mb-1 break-words",children:(t=e.studentDetails)==null?void 0:t.name}),a("p",{className:"text-xs sm:text-sm text-gray-600",children:[(n=e.studentDetails)==null?void 0:n.regNumber," â€¢ ",Q(e.studentDetails)]})]}),a("span",{className:`px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs font-semibold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 flex-shrink-0 whitespace-nowrap ${V[e.status]||"bg-gray-100 text-gray-700"}`,children:[s("span",{className:"text-xs sm:text-sm",children:z[e.status]||"ðŸ“„"}),s("span",{className:"text-xs",children:(e.status||"").replace(/_/g," ")})]})]}),a("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4",children:[a("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 sm:gap-6 text-xs sm:text-sm flex-1",children:[a("div",{children:[s("p",{className:"text-gray-500 mb-1 font-medium",children:"Parent:"}),s("p",{className:"font-medium text-gray-900 truncate",children:((o=e.studentDetails)==null?void 0:o.parentPhoneNumber)||"â€”"})]}),a("div",{children:[s("p",{className:"text-gray-500 mb-1 font-medium",children:"Requested:"}),s("p",{className:"font-medium text-gray-900",children:(l=e.dispatchRequest)!=null&&l.requestedAt?new Date(e.dispatchRequest.requestedAt).toLocaleDateString():"â€”"})]}),a("div",{children:[s("p",{className:"text-gray-500 mb-1 font-medium",children:"HOD Decision:"}),s("p",{className:"font-medium text-gray-900",children:(d=e.dispatchRequest)!=null&&d.hodResponse?e.dispatchRequest.hodResponse.toUpperCase():"â€”"})]})]}),a("div",{className:"w-full md:w-auto md:flex-shrink-0",children:[e.status==="verified_by_staff"&&s("button",{onClick:()=>O(e._id),disabled:m.includes(e._id),className:`w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-1 ${m.includes(e._id)?"bg-blue-300 cursor-wait":"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}`,children:m.includes(e._id)?"Requestingâ€¦":"Request Dispatch"}),e.status==="rescheduled_by_hod"&&s("button",{onClick:()=>O(e._id),disabled:m.includes(e._id),className:`w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-1 ${m.includes(e._id)?"bg-orange-300 cursor-wait":"bg-orange-500 hover:bg-orange-600 focus:ring-orange-500"}`,children:m.includes(e._id)?"Submittingâ€¦":"Request Again"}),e.status==="approved_by_hod"&&s("button",{onClick:()=>B(e),disabled:w===e._id,className:`w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-1 ${w===e._id?"bg-green-300 cursor-wait":"bg-green-600 hover:bg-green-700 focus:ring-green-500"}`,children:w===e._id?"Sendingâ€¦":"Send via WhatsApp"}),e.status==="rejected_by_hod"&&s("a",{href:`/marksheets/${e._id}`,className:"block w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-red-600 border border-red-200 bg-white hover:bg-red-50 text-center text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1",children:"Review Marksheet"}),e.status==="dispatched"&&s("a",{href:`/api/generate-pdf?marksheetId=${e._id}`,target:"_blank",rel:"noreferrer",className:"block w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-yellow-600 border border-yellow-300 bg-white hover:bg-yellow-50 hover:border-yellow-400 text-center text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-1",children:"Download PDF"})]})]}),((c=e.dispatchRequest)==null?void 0:c.hodComments)&&a("div",{className:"mt-4 bg-gray-50 border border-dashed border-gray-200 rounded-lg p-3",children:[s("p",{className:"text-xs text-gray-500 mb-1 font-medium",children:"HOD Comments:"}),s("p",{className:"text-gray-700 text-xs sm:text-sm",children:e.dispatchRequest.hodComments})]})]})},e._id)})})]})})]})})})}function Q(i={}){const r=(i.year||"").toString(),h=(i.section||"").toString();return!r&&!h?"â€”":h?r?r.includes("-")?r:`${r}-${h}`:h:r}export{te as default};
