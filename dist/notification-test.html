<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Windows Notification Test - MSEC Academics</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }
    .status-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #667eea;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .status-item:last-child {
      border-bottom: none;
    }
    .status-label {
      font-weight: 600;
      color: #555;
    }
    .status-value {
      font-weight: 500;
    }
    .status-ok {
      color: #28a745;
    }
    .status-error {
      color: #dc3545;
    }
    .status-warning {
      color: #ffc107;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin: 10px 0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .log-entry {
      margin: 4px 0;
      padding: 4px;
      border-left: 3px solid transparent;
    }
    .log-success {
      color: #4ec9b0;
      border-left-color: #4ec9b0;
    }
    .log-error {
      color: #f48771;
      border-left-color: #f48771;
    }
    .log-info {
      color: #9cdcfe;
      border-left-color: #9cdcfe;
    }
    .log-warning {
      color: #dcdcaa;
      border-left-color: #dcdcaa;
    }
    .icon {
      font-size: 48px;
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">üéì</div>
    <h1>MSEC Academics - Notification Test</h1>
    <p class="subtitle">Test push notifications for marksheet updates and academic events</p>

    <div class="status-box">
      <h3 style="margin-top:0;">System Status</h3>
      <div class="status-item">
        <span class="status-label">Browser:</span>
        <span class="status-value" id="browser">Checking...</span>
      </div>
      <div class="status-item">
        <span class="status-label">Platform:</span>
        <span class="status-value" id="platform">Checking...</span>
      </div>
      <div class="status-item">
        <span class="status-label">Service Worker:</span>
        <span class="status-value" id="sw-status">Checking...</span>
      </div>
      <div class="status-item">
        <span class="status-label">Push Manager:</span>
        <span class="status-value" id="push-status">Checking...</span>
      </div>
      <div class="status-item">
        <span class="status-label">Permission:</span>
        <span class="status-value" id="permission-status">Checking...</span>
      </div>
      <div class="status-item">
        <span class="status-label">Subscription:</span>
        <span class="status-value" id="subscription-status">Checking...</span>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <button onclick="checkStatus()">üîÑ Refresh Status</button>
      <button onclick="requestPermission()">üîî Enable Notifications</button>
      <button onclick="testMarksheetNotification()">ÔøΩ Marksheet Verified</button>
      <button onclick="testDispatchNotification()">üì§ Dispatch Requested</button>
      <button onclick="testApprovalNotification()">‚úÖ HOD Approval</button>
      <button onclick="testAcademicNotification()">üéì Academic Update</button>
      <button onclick="testMultipleAcademicNotifications()">üìÆ Test All (4)</button>
      <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script>
    const log = (message, type = 'info') => {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    };

    const clearLog = () => {
      document.getElementById('log').innerHTML = '';
      log('Log cleared', 'info');
    };

    const updateStatus = (id, value, isOk) => {
      const el = document.getElementById(id);
      el.textContent = value;
      el.className = `status-value ${isOk ? 'status-ok' : isOk === false ? 'status-error' : 'status-warning'}`;
    };

    const checkStatus = async () => {
      log('üîç Checking system status...', 'info');

      // Browser detection
      const ua = navigator.userAgent;
      let browser = 'Unknown';
      if (ua.includes('Edg')) browser = 'Microsoft Edge';
      else if (ua.includes('Chrome')) browser = 'Google Chrome';
      else if (ua.includes('Firefox')) browser = 'Mozilla Firefox';
      else if (ua.includes('Safari')) browser = 'Safari';
      updateStatus('browser', browser, true);
      log(`Browser: ${browser}`, 'info');

      // Platform
      const platform = navigator.platform || 'Unknown';
      const isWindows = platform.includes('Win') || ua.includes('Windows');
      updateStatus('platform', `${platform} ${isWindows ? '(Windows ‚úì)' : ''}`, isWindows);
      log(`Platform: ${platform}`, isWindows ? 'success' : 'warning');

      // Service Worker
      const swSupported = 'serviceWorker' in navigator;
      updateStatus('sw-status', swSupported ? 'Supported ‚úì' : 'Not Supported ‚úó', swSupported);
      log(`Service Worker: ${swSupported ? 'Supported' : 'Not Supported'}`, swSupported ? 'success' : 'error');

      // Push Manager
      const pushSupported = 'PushManager' in window;
      updateStatus('push-status', pushSupported ? 'Supported ‚úì' : 'Not Supported ‚úó', pushSupported);
      log(`Push Manager: ${pushSupported ? 'Supported' : 'Not Supported'}`, pushSupported ? 'success' : 'error');

      // Permission
      const permission = Notification.permission;
      const permissionMap = {
        'granted': { text: 'Granted ‚úì', ok: true },
        'denied': { text: 'Denied ‚úó', ok: false },
        'default': { text: 'Not Requested', ok: null }
      };
      const permInfo = permissionMap[permission] || { text: permission, ok: null };
      updateStatus('permission-status', permInfo.text, permInfo.ok);
      log(`Permission: ${permission}`, permInfo.ok ? 'success' : permInfo.ok === false ? 'error' : 'warning');

      // Subscription
      if (swSupported && pushSupported) {
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            const subscription = await registration.pushManager.getSubscription();
            updateStatus('subscription-status', subscription ? 'Active ‚úì' : 'Not Subscribed', !!subscription);
            log(`Subscription: ${subscription ? 'Active' : 'Not Subscribed'}`, subscription ? 'success' : 'warning');
          } else {
            updateStatus('subscription-status', 'No Service Worker', false);
            log('No Service Worker registration found', 'warning');
          }
        } catch (error) {
          updateStatus('subscription-status', 'Error', false);
          log(`Error checking subscription: ${error.message}`, 'error');
        }
      } else {
        updateStatus('subscription-status', 'Not Available', false);
      }

      log('‚úÖ Status check complete', 'success');
    };

    const requestPermission = async () => {
      log('üì¢ Requesting notification permission...', 'info');
      
      if (!('Notification' in window)) {
        log('‚ùå Notifications not supported', 'error');
        alert('Your browser does not support notifications');
        return;
      }

      if (Notification.permission === 'granted') {
        log('‚úÖ Permission already granted', 'success');
        alert('‚úì Notifications are already enabled!');
        return;
      }

      if (Notification.permission === 'denied') {
        log('‚ùå Permission denied - Please enable in browser settings', 'error');
        const browser = navigator.userAgent.includes('Edg') ? 'Edge' : 'Chrome';
        alert(`Notifications are blocked!\n\nTo enable:\n1. Click the lock icon in address bar\n2. Click "Permissions" or "Site settings"\n3. Set Notifications to "Allow"\n4. Refresh this page`);
        return;
      }

      try {
        const permission = await Notification.requestPermission();
        log(`Permission result: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        
        if (permission === 'granted') {
          log('‚úÖ Notifications enabled!', 'success');
          alert('‚úì Notifications enabled successfully!');
          checkStatus();
        } else {
          log('‚ö†Ô∏è Permission not granted', 'warning');
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        alert('Error: ' + error.message);
      }
    };

    const testMarksheetNotification = async () => {
      log('ÔøΩ Testing marksheet verification notification...', 'info');

      if (Notification.permission !== 'granted') {
        log('‚ùå Permission not granted', 'error');
        alert('Please enable notifications first!');
        return;
      }

      try {
        let registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          log('üìù Registering service worker...', 'info');
          registration = await navigator.serviceWorker.register('/service-worker.js');
          await navigator.serviceWorker.ready;
          log('‚úÖ Service worker registered', 'success');
        }

        await registration.showNotification('üìã Marksheet Verified', {
          body: 'Your marksheet has been verified by the staff member.\nCS-2024-001 | Total Marks: 95/100',
          icon: '/images/android-chrome-192x192.png',
          badge: '/images/favicon-32x32.png',
          tag: 'marksheet-verified-' + Date.now(),
          requireInteraction: false,
          renotify: true,
          timestamp: Date.now()
        });

        log('‚úÖ Marksheet verification notification sent', 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        alert('Error: ' + error.message);
      }
    };

    const testDispatchNotification = async () => {
      log('üì§ Testing dispatch request notification...', 'info');

      if (Notification.permission !== 'granted') {
        log('‚ùå Permission not granted', 'error');
        alert('Please enable notifications first!');
        return;
      }

      try {
        let registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          registration = await navigator.serviceWorker.register('/service-worker.js');
          await navigator.serviceWorker.ready;
        }

        await registration.showNotification('üì§ Dispatch Request', {
          body: 'Marksheet dispatch has been requested for Mid Term Exam.\n15 marksheets queued for WhatsApp delivery',
          icon: '/images/android-chrome-192x192.png',
          badge: '/images/favicon-32x32.png',
          tag: 'dispatch-request-' + Date.now(),
          requireInteraction: false,
          renotify: true,
          timestamp: Date.now()
        });

        log('‚úÖ Dispatch request notification sent', 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        alert('Error: ' + error.message);
      }
    };

    const testApprovalNotification = async () => {
      log('‚úÖ Testing HOD approval notification...', 'info');

      if (Notification.permission !== 'granted') {
        log('‚ùå Permission not granted', 'error');
        alert('Please enable notifications first!');
        return;
      }

      try {
        let registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          registration = await navigator.serviceWorker.register('/service-worker.js');
          await navigator.serviceWorker.ready;
        }

        await registration.showNotification('‚úÖ Approved by HOD', {
          body: 'Your marksheet dispatch request has been approved.\n12 marksheets approved | Ready for dispatch',
          icon: '/images/android-chrome-192x192.png',
          badge: '/images/favicon-32x32.png',
          tag: 'hod-approval-' + Date.now(),
          requireInteraction: false,
          renotify: true,
          timestamp: Date.now()
        });

        log('‚úÖ HOD approval notification sent', 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        alert('Error: ' + error.message);
      }
    };

    const testAcademicNotification = async () => {
      log('üéì Testing academic update notification...', 'info');

      if (Notification.permission !== 'granted') {
        log('‚ùå Permission not granted', 'error');
        alert('Please enable notifications first!');
        return;
      }

      try {
        let registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          registration = await navigator.serviceWorker.register('/service-worker.js');
          await navigator.serviceWorker.ready;
        }

        await registration.showNotification('üéì Academic Update', {
          body: 'New examination schedule: Final Year End Exam\nScheduled for: December 15 - 30, 2025',
          icon: '/images/android-chrome-192x192.png',
          badge: '/images/favicon-32x32.png',
          tag: 'academic-update-' + Date.now(),
          requireInteraction: false,
          renotify: true,
          timestamp: Date.now()
        });

        log('‚úÖ Academic update notification sent', 'success');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        alert('Error: ' + error.message);
      }
    };

    const testMultipleAcademicNotifications = async () => {
      log('üìÆ Testing multiple MSEC academic notifications...', 'info');

      if (Notification.permission !== 'granted') {
        log('‚ùå Permission not granted', 'error');
        alert('Please enable notifications first!');
        return;
      }

      const notifications = [
        { title: 'üìã Marksheet Verified', body: 'Your marksheet for Mid Term has been verified.\nTotal: 87/100 | Grade: A', delay: 0 },
        { title: 'üì§ Dispatch Queued', body: 'Marksheet dispatch request sent to HOD for approval.\n5 marksheets pending', delay: 1000 },
        { title: '‚úÖ Approved by HOD', body: 'HOD has approved your dispatch request!\nDispatch begins shortly', delay: 2000 },
        { title: 'üéì Marks Dispatched', body: 'Marksheets have been sent via WhatsApp to all students.\nDelivery: 23 Nov 2025 at 2:30 PM', delay: 3000 }
      ];

      for (let i = 0; i < notifications.length; i++) {
        const notif = notifications[i];
        setTimeout(() => {
          try {
            new Notification(notif.title, {
              body: notif.body,
              icon: '/images/android-chrome-192x192.png',
              badge: '/images/favicon-32x32.png',
              tag: `msec-workflow-${Date.now()}-${i}`,
              requireInteraction: false,
              timestamp: Date.now()
            });
            log(`‚úÖ Sent: ${notif.title}`, 'success');
          } catch (error) {
            log(`‚ùå Failed to send ${notif.title}: ${error.message}`, 'error');
          }
        }, notif.delay);
      }

      log('üìÆ Sending 4 MSEC academic workflow notifications with 1s intervals...', 'info');
    };

    // Initial status check
    window.addEventListener('load', () => {
      log('üöÄ MSEC Academics Notification Test loaded', 'success');
      checkStatus();
    });
  </script>
</body>
</html>
